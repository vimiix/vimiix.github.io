<!doctype html><html lang=cn-zh><head><meta charset=UTF-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=X-UA-Compatible content="IE=edge"><style type=text/css>body{font-family:monospace}</style><title>Python|py2中字符与字节之间的编解码</title>
<meta name=description content="A blog maintained by Vimiix."><link rel=stylesheet href=/vimiix-blog/css/style.css></head><body><header>====================<br>== Hi, I'm Vimiix ==<br>====================<div style=float:right>Practice makes perfect (ง •̀_•́)ง</div><br><p><nav><a href=http://www.vimiix.com/vimiix-blog/><b>首页</b></a>.
<a href=/vimiix-blog/posts/><b>文章列表</b></a>.
<a href=/vimiix-blog/categories/><b>分类</b></a>.
<a href=/vimiix-blog/tags/><b>标签</b></a>.
<a href=/vimiix-blog/friends/><b>友链</b></a>.
<a href=/vimiix-blog/about/><b>关于</b></a>.
<a href=/vimiix-blog/index.xml><b>RSS</b></a>.</nav></p></header><main><article><h1>Python|py2中字符与字节之间的编解码</h1><b><time>2017.03.28 13:56</time></b>
<a href=/vimiix-blog/%20/tags/python>Python</a><div><p>据说，每个做 Python 开发的都被字符编码的问题搞晕过，最常见的错误就是 UnicodeEncodeError、UnicodeDecodeError，你好像知道怎么解决，遗憾的是，错误又出现在其它地方，问题总是重蹈覆辙，str 到 unicode 之间的转换用哪 decode 还是 encode 方法还特不好记，老是混淆，问题究竟出在哪里？</p><p>为了弄清楚这个问题，我决定从 python 字符串的构成以及字符编码的细节上进行深入浅出的分析</p><p><figure><img src=http://vimiix-blog.oss-cn-qingdao.aliyuncs.com/f3c4c96.jpg alt></figure></p><h6 id=题图unsplashcom>题图：unsplash.com</h6><h6 id=声明本文转自公众号python-之禅httpsmpweixinqqcomslqrpmp2hmlw5c7izjiuhnq>声明：本文转自公众号<a href=https://mp.weixin.qq.com/s/LQrPmp2HMlw5C7izJIUHNQ>Python 之禅</a></h6><h2 id=字节与字符>字节与字符</h2><p>计算机存储的一切数据，文本字符、图片、视频、音频、软件都是由一串 01 的字节序列构成的，一个字节等于 8 个比特位。</p><p>而字符就是一个符号，比如一个汉字、一个英文字母、一个数字、一个标点都可以称为一个字符。</p><p>字节方便存储和网络传输，而字符用于显示，方便阅读。字符 “p” 保存到硬盘就是一串二进制数据 01110000，占用一个字节的长度</p><h2 id=编码与解码>编码与解码</h2><p>我们用编辑器打开的文本，看到的一个个字符，最终保存在磁盘的时候都是以二进制字节序列形式存起来的。那么从字符到字节的转换过程就叫做编码（encode），反过来叫做解码（decode），两者是一个可逆的过程。编码是为了存储传输，解码是为了方便显示阅读。</p><p>例如字符 “p” 保存到硬盘是一串二进制 01110000 ，占用一个字节的长度。字符 “禅” 有可能是以 “11100111 10100110 10000101” 占用 3 个字节的长度存储，为什么说是有可能呢？这个放到后面再说。</p><p>Python 编码为什么那么蛋疼？当然，这不能怪开发者。</p><p>这是因为 Python2 使用 ASCII 字符编码作为默认编码方式，而 ASCII 不能处理中文，那么为什么不用 UTf-8 呢？因为 Guido 老爹为 Python 编写第一行代码是在 1989 年的冬天，1991 年 2 月正式开源发布了第一个版本，而 Unicode 是 1991 年 10 月发布的，也就是说 Python 这门语言创立的时候 UTF-8 还没诞生，这是其一。</p><p>Python 把字符串的类型还搞成两种，unicode 和 str ，以至于把开发者都弄糊涂了，这是其二。python3 就彻底把 字符串重新改造了，只保留一种类型，这是后话，以后再说。</p><h2 id=str-与-unicode>str 与 unicode</h2><p>Python2 把字符串分为 unicode 和 str 两种类型。本质上 str 是一串二进制字节序列，下面的示例代码可以看出 str 类型的 “禅” 打印出来是十六进制的 \xec\xf8 ，对应的二进制字节序列就是 ‘11101100 11111000’。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Python data-lang=Python><span style=display:flex><span>	<span style=color:#f92672>&gt;&gt;&gt;</span> s <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;禅&#39;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&gt;&gt;&gt;</span> s
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\xec\xf8</span><span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&gt;&gt;&gt;</span> type(s)
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;</span>type <span style=color:#e6db74>&#39;str&#39;</span><span style=color:#f92672>&gt;</span>
</span></span></code></pre></div><p>而 unicode 类型的 u”禅” 对应的 unicode 符号是 u’\u7985’</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Python data-lang=Python><span style=display:flex><span>	<span style=color:#f92672>&gt;&gt;&gt;</span> u <span style=color:#f92672>=</span> <span style=color:#e6db74>u</span><span style=color:#e6db74>&#34;禅&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&gt;&gt;&gt;</span> u
</span></span><span style=display:flex><span>	<span style=color:#e6db74>u</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\u7985</span><span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&gt;&gt;&gt;</span> type(u)
</span></span><span style=display:flex><span>	<span style=color:#f92672>&lt;</span>type <span style=color:#e6db74>&#39;unicode&#39;</span><span style=color:#f92672>&gt;</span>
</span></span></code></pre></div><p>我们要把 unicode 符号保存到文件或者传输到网络就需要经过编码处理转换成 str 类型，于是 python 提供了 encode 方法，从 unicode 转换到 str，反之亦然。</p><p><figure><img src=http://vimiix-blog.oss-cn-qingdao.aliyuncs.com/xxx.png alt></figure></p><h5 id=encode>encode</h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Python data-lang=Python><span style=display:flex><span>	<span style=color:#f92672>&gt;&gt;&gt;</span> u <span style=color:#f92672>=</span> <span style=color:#e6db74>u</span><span style=color:#e6db74>&#34;禅&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&gt;&gt;&gt;</span> u
</span></span><span style=display:flex><span>	<span style=color:#e6db74>u</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\u7985</span><span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&gt;&gt;&gt;</span> u<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#34;utf-8&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\xe7\xa6\x85</span><span style=color:#e6db74>&#39;</span>
</span></span></code></pre></div><h5 id=decode>decode</h5><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Python data-lang=Python><span style=display:flex><span>	<span style=color:#f92672>&gt;&gt;&gt;</span> s <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;禅&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&gt;&gt;&gt;</span> s<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#34;utf-8&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#e6db74>u</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\u7985</span><span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&gt;&gt;&gt;</span>
</span></span></code></pre></div><p>不少初学者怎么也记不住 str 与 unicode 之间的转换用 encode 还是 decode，如果你记住了 str 本质上其实是一串二进制数据，而 unicode 是字符（符号），编码（encode）就是把字符（符号）转换为 二进制数据的过程，因此 unicode 到 str 的转换要用 encode 方法，反过来就是用 decode 方法。</p><blockquote><p>encoding always takes a Unicode string and returns a bytes sequence, and decoding always takes a bytes sequence and returns a Unicode string”.</p></blockquote><p>清楚了 str 与 unicode 之间的转换关系之后，我们来看看什么时候会出现 UnicodeEncodeError、UnicodeDecodeError 错误。</p><p>##UnicodeEncodeError</p><p>UnicodeEncodeError 发生在 unicode 字符串转换成 str 字节序列的时候，来看一个例子，把一串 unicode 字符串保存到文件</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Python data-lang=Python><span style=display:flex><span>	<span style=color:#75715e># -*- coding:utf-8 -*-</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
</span></span><span style=display:flex><span>	    name <span style=color:#f92672>=</span> <span style=color:#e6db74>u</span><span style=color:#e6db74>&#39;Python之禅&#39;</span>
</span></span><span style=display:flex><span>	    f <span style=color:#f92672>=</span> open(<span style=color:#e6db74>&#34;output.txt&#34;</span>, <span style=color:#e6db74>&#34;w&#34;</span>)
</span></span><span style=display:flex><span>	    f<span style=color:#f92672>.</span>write(name)
</span></span></code></pre></div><h5 id=错误日志>错误日志</h5><blockquote><p>UnicodeEncodeError: ‘ascii’ codec can’t encode characters in position 6-7: ordinal not in range(128)</p></blockquote><p>为什么会出现 UnicodeEncodeError？</p><p>因为调用 write 方法时，Python 会先判断字符串是什么类型，如果是 str，就直接写入文件，不需要编码，因为 str 类型的字符串本身就是一串二进制的字节序列了。</p><p>如果字符串是 unicode 类型，那么它会先调用 encode 方法把 unicode 字符串转换成二进制形式的 str 类型，才保存到文件，而 encode 方法会使用 python 默认的 ascii 码来编码</p><p>相当于：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Python data-lang=Python><span style=display:flex><span>	<span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#e6db74>u</span><span style=color:#e6db74>&#34;Python之禅&#34;</span><span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#34;ascii&#34;</span>)
</span></span></code></pre></div><p>但是，我们知道 ASCII 字符集中只包含了 128 个拉丁字母，不包括中文字符，因此 出现了 ‘ascii’ codec can’t encode characters 的错误。要正确地使用 encode ，就必须指定一个包含了中文字符的字符集，比如：UTF-8、GBK。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Python data-lang=Python><span style=display:flex><span>	<span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#e6db74>u</span><span style=color:#e6db74>&#34;Python之禅&#34;</span><span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#34;utf-8&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#39;Python</span><span style=color:#ae81ff>\xe4\xb9\x8b\xe7\xa6\x85</span><span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&gt;&gt;&gt;</span> <span style=color:#e6db74>u</span><span style=color:#e6db74>&#34;Python之禅&#34;</span><span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#34;gbk&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#39;Python</span><span style=color:#ae81ff>\xd6\xae\xec\xf8</span><span style=color:#e6db74>&#39;</span>
</span></span></code></pre></div><p>所以要把 unicode 字符串正确地写入文件，就应该预先把字符串进行 UTF-8 或 GBK 编码转换。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Python data-lang=Python><span style=display:flex><span>	<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>main</span>():
</span></span><span style=display:flex><span>	    name <span style=color:#f92672>=</span> <span style=color:#e6db74>u</span><span style=color:#e6db74>&#39;Python之禅&#39;</span>
</span></span><span style=display:flex><span>	    name <span style=color:#f92672>=</span> name<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#39;utf-8&#39;</span>)
</span></span><span style=display:flex><span>	    <span style=color:#66d9ef>with</span> open(<span style=color:#e6db74>&#34;output.txt&#34;</span>, <span style=color:#e6db74>&#34;w&#34;</span>) <span style=color:#66d9ef>as</span> f:
</span></span><span style=display:flex><span>	        f<span style=color:#f92672>.</span>write(name)
</span></span></code></pre></div><p>当然，把 unicode 字符串正确地写入文件不止一种方式，但原理是一样的，这里不再介绍，把字符串写入数据库，传输到网络都是同样的原理</p><h2 id=unicodedecodeerror>UnicodeDecodeError</h2><p>UnicodeDecodeError 发生在 str 类型的字节序列解码成 unicode 类型的字符串时</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Python data-lang=Python><span style=display:flex><span>	<span style=color:#f92672>&gt;&gt;&gt;</span> a <span style=color:#f92672>=</span> <span style=color:#e6db74>u</span><span style=color:#e6db74>&#34;禅&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&gt;&gt;&gt;</span> a
</span></span><span style=display:flex><span>	<span style=color:#e6db74>u</span><span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\u7985</span><span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&gt;&gt;&gt;</span> b <span style=color:#f92672>=</span> a<span style=color:#f92672>.</span>encode(<span style=color:#e6db74>&#34;utf-8&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#f92672>&gt;&gt;&gt;</span> b
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\xe7\xa6\x85</span><span style=color:#e6db74>&#39;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&gt;&gt;&gt;</span> b<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#34;gbk&#34;</span>)
</span></span><span style=display:flex><span>	Traceback (most recent call last):
</span></span><span style=display:flex><span>	  File <span style=color:#e6db74>&#34;&lt;stdin&gt;&#34;</span>, line <span style=color:#ae81ff>1</span>, <span style=color:#f92672>in</span> <span style=color:#f92672>&lt;</span>module<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>UnicodeDecodeError</span>: <span style=color:#e6db74>&#39;gbk&#39;</span> codec can<span style=color:#e6db74>&#39;t decode byte 0x85 in position 2: incomplete multibyte sequence</span>
</span></span></code></pre></div><p>把一个经过 UTF-8 编码后生成的字节序列 ‘\xe7\xa6\x85’ 再用 GBK 解码转换成 unicode 字符串时，出现 UnicodeDecodeError，因为 （对于中文字符）GBK 编码只占用两个字节，而 UTF-8 占用 3 个字节，用 GBK 转换时，还多出一个字节，因此它没法解析。避免 UnicodeDecodeError 的关键是保持 编码和解码时用的编码类型一致。</p><p>这也回答了文章开头说的字符 “禅”，保存到文件中有可能占 3 个字节，有可能占 2 个字节，具体处决于 encode 的时候指定的编码格式是什么。</p><p>再举一个 UnicodeDecodeError 的例子</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Python data-lang=Python><span style=display:flex><span>	<span style=color:#f92672>&gt;&gt;&gt;</span> x <span style=color:#f92672>=</span> <span style=color:#e6db74>u</span><span style=color:#e6db74>&#34;Python&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&gt;&gt;&gt;</span> y <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;之禅&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&gt;&gt;&gt;</span> x <span style=color:#f92672>+</span> y
</span></span><span style=display:flex><span>	Traceback (most recent call last):
</span></span><span style=display:flex><span>	  File <span style=color:#e6db74>&#34;&lt;stdin&gt;&#34;</span>, line <span style=color:#ae81ff>1</span>, <span style=color:#f92672>in</span> <span style=color:#f92672>&lt;</span>module<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>UnicodeDecodeError</span>: <span style=color:#e6db74>&#39;ascii&#39;</span> codec can<span style=color:#e6db74>&#39;t decode byte 0xe4 in position 0: ordinal not in range(128)</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&gt;&gt;&gt;</span>
</span></span></code></pre></div><p>str 与 unicode 字符串 执行 + 操作是，Python 会把 str 类型的字节序列隐式地转换成（解码）成 和 x 一样的 unicode 类型，但 Python 是使用默认的 ascii 编码来转换的，而 ASCII 中不包含中文，所以报错了。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Python data-lang=Python><span style=display:flex><span>	<span style=color:#f92672>&gt;&gt;&gt;</span> y<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#39;ascii&#39;</span>)
</span></span><span style=display:flex><span>	Traceback (most recent call last):
</span></span><span style=display:flex><span>	  File <span style=color:#e6db74>&#34;&lt;stdin&gt;&#34;</span>, line <span style=color:#ae81ff>1</span>, <span style=color:#f92672>in</span> <span style=color:#f92672>&lt;</span>module<span style=color:#f92672>&gt;</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>UnicodeDecodeError</span>: <span style=color:#e6db74>&#39;ascii&#39;</span> codec can<span style=color:#e6db74>&#39;t decode byte 0xe4 in position 0: ordinal not in range(128)</span>
</span></span></code></pre></div><p>正确地方式应该是显示地把 y 用 UTF-8 或者 GBK 进行解码。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-Python data-lang=Python><span style=display:flex><span>	<span style=color:#f92672>&gt;&gt;&gt;</span> x <span style=color:#f92672>=</span> <span style=color:#e6db74>u</span><span style=color:#e6db74>&#34;Python&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&gt;&gt;&gt;</span> y <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;之禅&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#f92672>&gt;&gt;&gt;</span> y <span style=color:#f92672>=</span> y<span style=color:#f92672>.</span>decode(<span style=color:#e6db74>&#34;utf-8&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#f92672>&gt;&gt;&gt;</span> x <span style=color:#f92672>+</span> y
</span></span><span style=display:flex><span>	<span style=color:#e6db74>u</span><span style=color:#e6db74>&#39;Python</span><span style=color:#ae81ff>\u4e4b\u7985</span><span style=color:#e6db74>&#39;</span>
</span></span></code></pre></div></div></article></main><aside><div><div><h3>LATEST POSTS</h3></div><div><ul><li><a href=/vimiix-blog/posts/2024-02-20-be-a-better-developer-with-these-git-good-practices/>[译]做一个拥有 Git 好习惯的开发者</a></li><li><a href=/vimiix-blog/posts/2023-12-15-ssx/>SSX，一个有记忆的 ssh 客户端</a></li><li><a href=/vimiix-blog/posts/2023-06-21-manage-go-multiple-versions/>Shell 函数实现Go语言多版本管理轻量级方案</a></li><li><a href=/vimiix-blog/posts/2021-12-21-learn-distributed-transaction/>分布式事务笔记(XA,TCC,Saga)</a></li><li><a href=/vimiix-blog/posts/2021-09-01-simulate-disk-readonly-scenario/>磁盘只读（readonly）故障场景模拟</a></li></ul></div></div></aside><div id=disqus_thread></div><script>var disqus_config=function(){this.page.url="http://www.vimiix.com/vimiix-blog/posts/2017-03-28-encode-and-decode/",this.page.identifier="/vimiix-blog/posts/2017-03-28-encode-and-decode/"};(function(){var e=document,t=e.createElement("script");t.src="https://vimiix-blog.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><footer><p><a href=https://github.com/vimiix><b>Github</b></a>.
<a href=https://www.douban.com/people/vimiix/><b>Douban</b></a>.
<a href=mailto:i@vimiix.com><b>Email</b></a>.<br>&copy; 2024
Copyright (c) 2017-2021, Vimiix Yao; All rights reserved.
<a href=https://beian.miit.gov.cn/>京ICP备19015214号-1</a></p></footer></body></html>