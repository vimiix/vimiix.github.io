<!doctype html><html lang=cn-zh><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="IE=edge"><style type=text/css>body{font-family:monospace}</style><title>自动化DDL审核|pymysql链接Inception中踩过的几个坑</title><meta name=description content="A blog maintained by Vimiix."><link rel=stylesheet href=/css/style.css></head><body><header>====================<br>== Hi, I'm Vimiix ==<br>====================<div style=float:right>Practice makes perfect (ง •̀_•́)ง</div><br><p><nav><a href=https://www.vimiix.com/><b>首页</b></a>.
<a href=/posts/><b>文章列表</b></a>.
<a href=/categories/><b>分类</b></a>.
<a href=/tags/><b>标签</b></a>.
<a href=/friends/><b>友链</b></a>.
<a href=/about/><b>关于</b></a>.
<a href=/index.xml><b>RSS</b></a>.</nav></p></header><main><article><h1>自动化DDL审核|pymysql链接Inception中踩过的几个坑</h1><b><time>2017.09.28 19:12</time></b>
<a href=/%20/tags/pymsql>pymsql</a>
<a href=/%20/tags/inception>Inception</a>
<a href=/%20/tags/python>Python</a><div><p>简单整理了一下这几天使用 pymysql 链接 inception 做 sql 审核过程中出现的坑和解决方法。</p><p>这些解决方法一定不是最漂亮的，如果有伙伴遇到同样的问题，并且有好的解决方案，请一定在留言中回一下我哦。</p><p>先行感激！！</p><h2 id=pymysql-在链接-inception-在判断版本时出现-value-error>Pymysql 在链接 inception 在判断版本时出现 value error</h2><h3 id=原因>原因：</h3><p>pymysql 通过<code>.</code>进行分割，但是 Inception 的版本信息是这样的</p><p><code>Ver 14.14 Distrib Inception2.1.50, for Linux (x86_64) using EditLine wrapper</code></p><p>正常 Mysql 的版本号是：</p><p><code>mysql Ver 14.14 Distrib 5.7.18, for Linux (x86_64) using EditLine wrapper</code></p><p>因此 Pymysql 获取到的版本值为 Inception2，所以在内部强制类型转换<code>int()</code>的时候报 value error。</p><h3 id=解决方法修改-pymysql-源码>解决方法（修改 pymysql 源码）：</h3><p>修改 Pymysql 文件夹内的 connections.py</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python>    <span style=color:#66d9ef>def</span> <span style=color:#a6e22e>_request_authentication</span>(self):
        <span style=color:#75715e># https://dev.mysql.com/doc/internals/en/connection-phase-packets.html#packet-Protocol::HandshakeResponse</span>
        <span style=color:#66d9ef>if</span> self<span style=color:#f92672>.</span>server_version<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;.&#39;</span>, <span style=color:#ae81ff>1</span>)[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;Inception2&#39;</span>:
            self<span style=color:#f92672>.</span>client_flag <span style=color:#f92672>|=</span> CLIENT<span style=color:#f92672>.</span>MULTI_RESULTS
        <span style=color:#66d9ef>elif</span> int(self<span style=color:#f92672>.</span>server_version<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;.&#39;</span>, <span style=color:#ae81ff>1</span>)[<span style=color:#ae81ff>0</span>]) <span style=color:#f92672>&gt;=</span> <span style=color:#ae81ff>5</span>:
            self<span style=color:#f92672>.</span>client_flag <span style=color:#f92672>|=</span> CLIENT<span style=color:#f92672>.</span>MULTI_RESULTS
</code></pre></div><p>这样的方式可以解决问题，但总觉得不妥，没法普及，不然需要带着修改过的 Pymysql 包 -。-|| )</p><h2 id=inception-始终反馈must-start-as-begin-statement的语法错误>Inception 始终反馈"Must start as begin statement"的语法错误</h2><blockquote><p>注意！ 这个问题是出现在正确书写了 inception 的语法格式情况下，</p><p>语法规则:</p><p>/<em>&ndash;user=username;&ndash;password=xxxx;&ndash;host=127.0.0.1;&ndash;port=3306;</em>/</p><p>inception_magic_start;</p><p>&mldr; # 这里写 sql 语句；</p><p>inception_maigc_commit;</p><p>如果是语法问题，请先自行检查语法。</p></blockquote><h3 id=原因-1>原因：</h3><p>pymysql 模块会自动向 inception 发送 SHOW WARNINGS 语句，而恰好这个 warnings 被 inception 捕捉到了，从而导致 inception 返回一个"Must start as begin statement"错误被 archer 捕捉到报在日志里.</p><h3 id=解决方法>解决方法：</h3><p>很遗憾，目前的方法我依然是修改 pymsql 的源码，请修改<code>pymysql/cursors.py:338行</code>，将<code>self._show_warnings()</code>这一句注释掉，换成 pass，如下：</p><p><figure><img src=http://vimiix-blog.oss-cn-qingdao.aliyuncs.com/modify-pymysql.png alt></figure></p><p>依旧，这个方法有副作用，会导致所有调用该 pymysql 模块的程序不能 show warnings，</p><h5 id=这个问题的解决方法>这个问题的解决方法：</h5><blockquote><p>推荐使用 virtualenv 或 venv 创建一个独立的 python 运行环境来管理包</p></blockquote><h2 id=执行时出现-commands-out-of-sync-的错误>执行时，出现 Commands out of sync 的错误</h2><h3 id=原因-2>原因：</h3><p>这个原因出现在应用层的话，检查在<code>fetch all</code>前面是否有<code>commit</code>，去掉之后，问题就解决了。</p><p>不需要手动 commit,默认会自动 commit</p></div></article></main><aside><div><div><h3>LATEST POSTS</h3></div><div><ul><li><a href=/posts/2021-04-07-concurrency-in-go/>Golang的并行模式实践</a></li><li><a href=/posts/2021-03-22-auth-windows-user-in-golang/>Golang实现Windows系统用户和密码校验</a></li><li><a href=/posts/2020-03-11-beanstalkd-note/>beanstalkd消息队列</a></li><li><a href=/posts/2020-02-21-richardson-model/>[译]Richardson成熟度模型</a></li><li><a href=/posts/2019-11-13-google-rtb-price-in-golang/>Golang实现Google在RTB广告中价格加密方案</a></li></ul></div></div></aside><div id=disqus_thread></div><script>var disqus_config=function(){this.page.url="https://www.vimiix.com/posts/2017-09-28-problems-when-pymysql-connect-inception/",this.page.identifier="/posts/2017-09-28-problems-when-pymysql-connect-inception/"};(function(){var a=document,b=a.createElement('script');b.src='https://vimiix-blog.disqus.com/embed.js',b.setAttribute('data-timestamp',+new Date),(a.head||a.body).appendChild(b)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><footer><p><a href=https://github.com/vimiix><b>Github</b></a>.
<a href=https://www.douban.com/people/vimiix/><b>Douban</b></a>.
<a href=mailto:i@vimiix.com><b>Email</b></a>.<br>&copy; 2021
Copyright (c) 2017-2021, Vimiix Yao; All rights reserved.
<a href=https://beian.miit.gov.cn/>京ICP备19015214号-1</a></p></footer></body></html>